<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Trilhas de Conhecimento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/time-picker.css}" />
    <link rel="stylesheet" th:href="@{/css/eixo-picker.css}" />
</head>
<body class="bg-gray-100">

<div class="flex h-screen">
    <aside class="w-60 bg-gray-200 p-6 flex flex-col gap-6">
        <div class="text-xl font-bold">BRASFI conecta</div>
        <nav class="flex flex-col gap-4">
            <button class="text-left text-lg font-medium">Dashboard</button>
            <button class="text-left text-lg font-medium">Trilhas</button>
            <button class="text-left text-lg font-medium">Grupos</button>
            <button class="text-left text-lg font-medium">Projetos</button>
        </nav>
    </aside>

    <main class="flex-1 p-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Trilhas de conhecimento</h1>
            <div class="flex items-center gap-4">
                <input type="text" placeholder="Pesquisar por trilhas ou aulas" class="border border-gray-300 rounded-full px-4 py-2 w-80"/>
                <div class="flex items-center gap-2">
                    <span class="font-semibold">Usuário</span>
                    <span class="text-sm text-gray-500">Cargo</span>
                </div>
            </div>
        </div>

        <div class="flex gap-4 mb-6">
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Todos</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Liderança</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Finanças</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Empreendedorismo</button>
            <button class="bg-gray-300 px-4 py-2 rounded-full text-sm">Saúde</button>
        </div>
        <button id="openNewTrilhaModalBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-6">
            + Criar Trilha
        </button>

        <div class="flex gap-6">
            <div class="grid grid-cols-3 gap-4 w-3/4">

                <div th:each="trilha : ${trilhas}" class="bg-white p-4 rounded-lg shadow relative">
                    <div th:style="'background-image: url(' + ${trilha.capa ?: 'https://via.placeholder.com/150'} + ')'"
                         class="h-32 bg-gray-200 rounded mb-4 bg-cover bg-center"></div>

                    <span th:text="${trilha.eixoTematico != null ? trilha.eixoTematico.toString() : 'N/A'}"
                          class="text-sm bg-gray-100 px-2 py-1 rounded text-gray-700"></span>

                    <div class="flex justify-between items-center mt-2">
                        <h2 th:text="${trilha.titulo}" class="font-semibold text-base"></h2>
                        <div class="relative group">
                            <button class="text-gray-500 hover:text-gray-800 px-2">
                                &#x22EE;
                            </button>
                            <div class="absolute right-0 mt-1 bg-white border border-gray-200 rounded shadow-md hidden group-hover:block z-10">
                                <button class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    Editar
                                </button>
                                <button class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-100"
                                        th:onclick="'abrirDeletarModal(\'modal-trilha-' + ${trilha.id} + '\')'">
                                    Deletar
                                </button>
                            </div>
                        </div>
                    </div>

                    <p th:text="${trilha.descricao}" class="text-sm text-gray-600"></p>
                    <div class="mt-2 text-yellow-500">★★★★☆ (123)</div>
                </div>

                <div th:each="trilha : ${trilhas}" th:id="'modal-trilha-' + ${trilha.id}"
                     class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md text-center">

                        <h2 class="text-xl font-bold text-gray-800 mb-2">Atenção!</h2>

                        <p class="text-gray-700 mb-6">
                            Você está deletando a trilha
                            <strong th:text="|“${trilha.titulo}”|">“”</strong>.
                            Deseja completar a ação? Não poderá ser desfeita.
                        </p>

                        <div class="flex justify-center gap-4">
                            <button th:onclick="'fecharDeletarModal(\'modal-trilha-' + ${trilha.id} + '\')'"
                                    class="px-5 py-2 border border-gray-400 bg-gray-100 text-gray-800 rounded hover:bg-gray-200">
                                Cancelar
                            </button>

                            <form th:action="@{/trilhas/{id}/deletar(id=${trilha.id})}" method="post">
                                <button type="submit"
                                        class="px-5 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    Sim, quero deletar.
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>

            <aside class="w-1/4 bg-white p-4 rounded-lg shadow h-fit">
                <h3 class="font-semibold mb-4">Sugestões:</h3>
                <div class="mb-3">
                    <p class="text-sm text-gray-500">Aula 01: Nome da aula</p>
                    <p class="text-xs text-gray-400">Nome do curso</p>
                    <a href="#" class="text-blue-600 text-xs">Acessar ></a>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Aula 02: Por que Sustentabilidade Importa?</p>
                    <p class="text-xs text-gray-400">Introdução à Finanças Sustentáveis</p>
                    <a href="#" class="text-blue-600 text-xs">Acessar ></a>
                </div>
            </aside>
        </div>
    </main>
</div>

<div id="newTrilhaModalContainer"></div>

<script>
    // Funções para o modal de DELETAR (já existentes)
    function abrirDeletarModal(id) {
        document.getElementById(id).classList.remove('hidden');
    }

    function fecharDeletarModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    // --- Script para o modal de CRIAR NOVA TRILHA ---
    const newTrilhaOpenBtn = document.getElementById('openNewTrilhaModalBtn');
    let newTrilhaModal = null; // Variável para armazenar a referência ao modal

    async function loadNewTrilhaModal() {
        if (!newTrilhaModal) { // Carrega o modal apenas uma vez
            try {
                const response = await fetch('/trilhas/criar-modal');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const htmlContent = await response.text();
                document.getElementById('newTrilhaModalContainer').innerHTML = htmlContent;

                newTrilhaModal = document.getElementById('modalRegistrarTrilha');
                const closeNewTrilhaBtn = newTrilhaModal.querySelector('#closeModal');

                if (closeNewTrilhaBtn) {
                    closeNewTrilhaBtn.addEventListener('click', closeNewTrilhaModal);
                }
                if (newTrilhaModal) {
                    newTrilhaModal.addEventListener('click', (e) => {
                        if (e.target === newTrilhaModal) {
                            closeNewTrilhaModal();
                        }
                    });
                }

                // *** AS FUNÇÕES DE INICIALIZAÇÃO AGORA SÃO CHAMADAS AQUI ***
                // Isso garante que o DOM do modal foi carregado e os scripts que definem
                // initializeEixoPicker e initializeTimePicker já foram executados.
                initializeEixoPicker();
                initializeTimePicker();

            } catch (error) {
                console.error("Erro ao carregar o modal de Nova Trilha:", error);
            }
        }
    }

    function openNewTrilhaModal() {
        // A lógica de carregamento do modal deve estar no 'then'
        // para garantir que o modal foi carregado ANTES de tentar abri-lo e inicializar os pickers.
        if (!newTrilhaModal) { // Se o modal ainda não foi carregado
            loadNewTrilhaModal().then(() => {
                // Após o carregamento bem-sucedido e inicialização dos pickers
                if (newTrilhaModal) {
                    newTrilhaModal.classList.remove('hidden');
                    newTrilhaModal.classList.add('flex');
                }
            });
        } else { // Se o modal já foi carregado
            newTrilhaModal.classList.remove('hidden');
            newTrilhaModal.classList.add('flex');
            // Re-inicializa os pickers aqui também caso o modal seja aberto novamente sem recarregar a página
            // Isso pode ser útil se o estado dos pickers precisar ser redefinido a cada abertura
            initializeEixoPicker();
            initializeTimePicker();
        }
    }

    function closeNewTrilhaModal() {
        if (newTrilhaModal) {
            newTrilhaModal.classList.remove('flex');
            newTrilhaModal.classList.add('hidden');
        }
    }

    // Adiciona o event listener ao botão de abrir o modal de Nova Trilha
    if (newTrilhaOpenBtn) {
        newTrilhaOpenBtn.addEventListener('click', openNewTrilhaModal);
    }
</script>
<script th:src="@{/js/eixo-picker.js}"></script>
<script th:src="@{/js/time-picker.js}"></script>

</body>
</html>